{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* 1. Scrollbar Styling */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* 2. Markdown Typography */
    .prose p { margin-bottom: 0.5em; }
    .prose ul { margin-top: 0.5em; margin-bottom: 0.5em; }
    .prose li { margin-top: 0; margin-bottom: 0; }
    
    /* Code Blocks */
    .prose pre { 
        background-color: #1e293b; 
        color: #e2e8f0;            
        border-radius: 0.5rem; 
        padding: 1rem; 
        font-size: 0.9em;
    }
    
    /* Inline Code */
    .prose code { 
        color: #0f172a;            
        background-color: #f1f5f9; 
        padding: 0.2rem 0.4rem; 
        border-radius: 0.25rem; 
        font-weight: 600; 
        font-size: 0.9em;
    }
    
    .prose pre code { 
        color: inherit; 
        background-color: transparent; 
        padding: 0; 
    }
    
    /* 3. Animation */
    .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

    /* 4. Full Screen Layout Fix */
    #interview-interface {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        top: 64px; /* JS will adjust this automatically */
        z-index: 50;
        background-color: white;
    }
</style>

<div id="interview-interface" class="flex flex-col font-sans">
    
    <div class="flex items-center justify-between px-6 py-3 border-b border-gray-100 bg-white/95 backdrop-blur-sm shadow-sm z-20">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-600 to-indigo-600 flex items-center justify-center text-white shadow-lg shadow-blue-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                </svg>
            </div>
            <div>
                <h1 class="font-bold text-gray-900 text-lg leading-tight">AI Interviewer</h1>
                <p class="text-xs text-gray-500 font-medium tracking-wide">Role: {{ analysis.job_title }}</p>
            </div>
        </div>
        <div class="flex items-center gap-2 px-3 py-1.5 bg-green-50 text-green-700 text-xs font-bold uppercase tracking-wider rounded-full border border-green-100">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            Live
        </div>
    </div>

    <div id="chat-box" class="flex-1 w-full overflow-y-auto no-scrollbar scroll-smooth pb-48 bg-gray-50"> 
        <div class="max-w-6xl mx-auto px-4 md:px-8 py-10 space-y-12">
            
            {% for msg in chat_history %}
                {% if msg.role == 'ai' %}
                    <div class="flex gap-6 fade-in group">
                        <div class="flex-shrink-0 mt-1">
                            <div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-blue-600 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.43 0 4.817.178 7.152.52 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97a48.901 48.901 0 01-3.476.383.39.39 0 00-.297.17l-2.755 4.133a.75.75 0 01-1.248 0l-2.755-4.133a.39.39 0 00-.297-.17 48.9 48.9 0 01-3.476-.384c-1.978-.29-3.348-2.024-3.348-2.024-3.348-3.97V6.741c0-1.946 1.37-3.68 3.348-3.97z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1 space-y-2">
                            <div class="font-bold text-sm text-gray-900 ml-1">Interviewer</div>
                            <div class="prose prose-slate max-w-none text-gray-700 leading-relaxed markdown-body bg-transparent">
                                {{ msg.content }}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="flex gap-6 flex-row-reverse fade-in">
                        <div class="flex-shrink-0 mt-1">
                            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1 text-right">
                            <div class="bg-white inline-block px-8 py-5 rounded-3xl rounded-tr-sm text-gray-800 text-left shadow-md border border-gray-100 text-lg leading-relaxed">
                                {{ msg.content|linebreaksbr }}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}

            <div id="typing-indicator" class="hidden flex gap-6 fade-in px-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 animate-pulse">
                            <path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.43 0 4.817.178 7.152.52 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97a48.901 48.901 0 01-3.476.383.39.39 0 00-.297.17l-2.755 4.133a.75.75 0 01-1.248 0l-2.755-4.133a.39.39 0 00-.297-.17 48.9 48.9 0 01-3.476-.384c-1.978-.29-3.348-2.024-3.348-2.024-3.348-3.97V6.741c0-1.946 1.37-3.68 3.348-3.97z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="flex items-center gap-1.5 h-10 bg-white px-4 rounded-full shadow-sm border border-gray-100 w-fit">
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce delay-75"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce delay-150"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="absolute bottom-0 left-0 w-full">
        <div class="max-w-5xl mx-auto">
            <div class="relative flex items-end gap-2 bg-white rounded-[32px] shadow-md border border-gray-200 focus-within:border-blue-400 transition-all duration-300">
                <textarea 
                    id="user-input" 
                    rows="1"
                    class="w-full bg-transparent border-0 focus:ring-0 text-gray-800 placeholder-gray-400 resize-none py-5 pl-8 pr-16 text-lg leading-relaxed max-h-60 rounded-[32px]"
                    placeholder="Type your answer here..."
                    style="min-height: 72px;"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                ></textarea>

                <button 
                    onclick="sendMessage()"
                    class="absolute bottom-3 right-3 p-3.5 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-200 flex items-center justify-center"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                    </svg>
                </button>
            </div>
            
            <p class="text-center text-xs text-gray-400 mt-4 font-medium">AI generated content. Code provided may require verification.</p>
        </div>
    </div>
</div>

<script>
    function adjustLayout() {
        const portal = document.getElementById('interview-interface');
        const header = document.querySelector('header') || document.querySelector('nav');
        if (header && portal) {
            portal.style.top = `${header.offsetHeight}px`;
        }
    }
    window.addEventListener('load', adjustLayout);
    window.addEventListener('resize', adjustLayout);

    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const typingIndicator = document.getElementById('typing-indicator');

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('.markdown-body').forEach(el => {
            const rawText = el.textContent.trim();
            if (rawText) el.innerHTML = marked.parse(rawText);
        });
        scrollToBottom();
        adjustLayout();
    });

    function scrollToBottom() {
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    }

    userInput.addEventListener("keydown", function(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        const userHtml = `
            <div class="flex gap-6 flex-row-reverse fade-in">
                <div class="flex-shrink-0 mt-1">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="flex-1 text-right">
                    <div class="bg-white inline-block px-8 py-5 rounded-3xl rounded-tr-sm text-gray-800 text-left shadow-md border border-gray-100 text-lg leading-relaxed">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                </div>
            </div>
        `;
        typingIndicator.insertAdjacentHTML('beforebegin', userHtml);
        
        userInput.value = '';
        userInput.style.height = 'auto'; 
        scrollToBottom();
        typingIndicator.classList.remove('hidden');
        scrollToBottom();

        try {
            const response = await fetch("{% url 'chat_api' analysis.id %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            typingIndicator.classList.add('hidden');

            if (data.error) { alert("Error: " + data.error); return; }

            const parsedContent = marked.parse(data.response);
            const aiHtml = `
                <div class="flex gap-6 fade-in group">
                    <div class="flex-shrink-0 mt-1">
                        <div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-blue-600 shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.43 0 4.817.178 7.152.52 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97a48.901 48.901 0 01-3.476.383.39.39 0 00-.297.17l-2.755 4.133a.75.75 0 01-1.248 0l-2.755-4.133a.39.39 0 00-.297-.17 48.9 48.9 0 01-3.476-.384c-1.978-.29-3.348-2.024-3.348-2.024-3.348-3.97V6.741c0-1.946 1.37-3.68 3.348-3.97z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1 space-y-2">
                        <div class="font-bold text-sm text-gray-900 ml-1">Interviewer</div>
                        <div class="prose prose-slate max-w-none text-gray-700 leading-relaxed markdown-body bg-transparent">
                            ${parsedContent}
                        </div>
                    </div>
                </div>
            `;
            typingIndicator.insertAdjacentHTML('beforebegin', aiHtml);
            scrollToBottom();

        } catch (error) {
            console.error(error);
            typingIndicator.classList.add('hidden');
        }
    }
</script>
{% endblock %}